{
  "feature": "Next.js 15 App Router Migration",
  "workflow_type": "refactor",
  "workflow_rationale": "This is a staged architectural migration from Pages Router to App Router. The refactor workflow ensures: (1) Dependencies are updated first, (2) New App Router structure is built alongside old, (3) Components are updated for new patterns, (4) Old pages directory is removed only after verification. This staged approach minimizes risk of breaking changes.",
  "phases": [
    {
      "id": "phase-1-dependencies",
      "name": "Dependency Upgrades",
      "type": "setup",
      "description": "Upgrade Next.js and related dependencies to latest versions",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Upgrade Next.js and core dependencies in package.json",
          "service": "main",
          "files_to_modify": [
            "package.json"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && pnpm install && pnpm next --version",
            "expected": "Next.js 15"
          },
          "notes": "Successfully upgraded all core dependencies:\n- next: 13.1.6 \u2192 15.5.9\n- next-axiom: 0.17.0 \u2192 1.10.0\n- cookies-next: 2.1.1 \u2192 6.1.1\n- @next/bundle-analyzer: 13.1.6 \u2192 15.5.9\n- eslint-config-next: 13.1.6 \u2192 15.5.9\nReact kept at 18.2.0 as per spec. All packages installed and verified.",
          "status": "completed",
          "updated_at": "2025-12-25T20:51:19.998952+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Update next.config.mjs for App Router compatibility",
          "service": "main",
          "files_to_modify": [
            "next.config.mjs"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && grep -v 'i18n' next.config.mjs | head -5",
            "expected": "No i18n config"
          },
          "notes": "Removed i18n configuration from next.config.mjs for App Router compatibility. The i18n config is incompatible with App Router and was causing conflicts. Kept withAxiom wrapper and reactStrictMode: true. Cleaned up outdated comments. Verified with grep command that no i18n config remains.",
          "status": "completed",
          "updated_at": "2025-12-25T20:52:48.367554+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Update environment variable schema for client-side Axiom",
          "service": "main",
          "files_to_modify": [
            "src/env.mjs",
            ".env.example"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && grep 'NEXT_PUBLIC_AXIOM' src/env.mjs",
            "expected": "NEXT_PUBLIC_AXIOM_DATASET"
          },
          "notes": "Added NEXT_PUBLIC_AXIOM_DATASET and NEXT_PUBLIC_AXIOM_TOKEN to client schema in src/env.mjs (both as optional strings). Added both variables to processEnv object for client-side access. Updated .env.example with the new client-side Axiom variables. These are required for next-axiom 1.x AxiomWebVitals component to work on the client side.",
          "status": "completed",
          "updated_at": "2025-12-25T20:54:17.121811+00:00"
        }
      ]
    },
    {
      "id": "phase-2-layout",
      "name": "Root Layout Setup",
      "type": "implementation",
      "description": "Create the App Router root layout as foundation for all pages",
      "depends_on": [
        "phase-1-dependencies"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create GoogleAnalytics client component for GTM/consent scripts",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/components/GoogleAnalytics.tsx"
          ],
          "patterns_from": [
            "src/pages/_app.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && head -1 src/components/GoogleAnalytics.tsx",
            "expected": "'use client'"
          },
          "notes": "Created GoogleAnalytics client component at src/components/GoogleAnalytics.tsx. Component includes 'use client' directive, uses useConsent hook, and extracts GTM/GA script logic from _app.tsx. Verification passed - file starts with 'use client'.",
          "status": "completed",
          "updated_at": "2025-12-25T20:55:48.181128+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Create src/app/layout.tsx root layout",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/layout.tsx"
          ],
          "patterns_from": [
            "src/pages/_app.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && cat src/app/layout.tsx | grep -E 'export default|html|body|Navigation|Footer'",
            "expected": "RootLayout with html, body, Navigation, Footer"
          },
          "notes": "Created src/app/layout.tsx root layout with all required components: Navigation, Footer, ToastContainer, GoogleAnalytics, AxiomWebVitals, and dynamic CookieConsent. Includes metadata export and html/body structure with lang=\"de\". Committed as eb23cbc.",
          "status": "completed",
          "updated_at": "2025-12-25T20:58:12.871720+00:00"
        }
      ]
    },
    {
      "id": "phase-3-hooks",
      "name": "Hook Updates",
      "type": "implementation",
      "description": "Update hooks for cookies-next v6 client/server split",
      "depends_on": [
        "phase-1-dependencies"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Update useConsent hook for cookies-next v6",
          "service": "main",
          "files_to_modify": [
            "src/lib/hooks/useConsent.ts"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && grep 'cookies-next/client' src/lib/hooks/useConsent.ts",
            "expected": "cookies-next/client"
          },
          "notes": "Updated useConsent hook for cookies-next v6: Added 'use client' directive, changed import to 'cookies-next/client', removed console.log. Commit: 52ccf39",
          "status": "completed",
          "updated_at": "2025-12-25T20:59:34.242071+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Add 'use client' directive to CookieConsent component",
          "service": "main",
          "files_to_modify": [
            "src/components/CookieConsent.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && head -1 src/components/CookieConsent.tsx",
            "expected": "'use client'"
          },
          "notes": "Add 'use client' as first line - component uses hooks and event handlers",
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-pages",
      "name": "Page Migration",
      "type": "implementation",
      "description": "Migrate all pages from Pages Router to App Router",
      "depends_on": [
        "phase-2-layout",
        "phase-3-hooks"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create home page at src/app/page.tsx",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/page.tsx"
          ],
          "patterns_from": [
            "src/pages/index.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/",
            "checks": [
              "Page renders",
              "Hero visible",
              "No console errors"
            ]
          },
          "notes": "Convert next/head to metadata export, keep dynamic imports for client components (Newsletter, Slider, etc). Page is Server Component by default.",
          "status": "pending"
        },
        {
          "id": "subtask-4-2",
          "description": "Create lashlift page at src/app/lashlift/page.tsx",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/lashlift/page.tsx"
          ],
          "patterns_from": [
            "src/pages/lashlift.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/lashlift",
            "checks": [
              "Page renders",
              "LastLift component visible"
            ]
          },
          "notes": "Convert to App Router page with metadata export. Same structure as home but with LastLift hero.",
          "status": "pending"
        },
        {
          "id": "subtask-4-3",
          "description": "Create lashextension-1-zu-1-technik page",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/lashextension-1-zu-1-technik/page.tsx"
          ],
          "patterns_from": [
            "src/pages/lashextension-1-zu-1-technik.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/lashextension-1-zu-1-technik",
            "checks": [
              "Page renders",
              "Content visible"
            ]
          },
          "notes": "Convert to App Router page with appropriate metadata.",
          "status": "pending"
        },
        {
          "id": "subtask-4-4",
          "description": "Create lashextension-volumentechnik page",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/lashextension-volumentechnik/page.tsx"
          ],
          "patterns_from": [
            "src/pages/lashextension-volumentechnik.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/lashextension-volumentechnik",
            "checks": [
              "Page renders",
              "Content visible"
            ]
          },
          "notes": "Convert to App Router page with appropriate metadata.",
          "status": "pending"
        },
        {
          "id": "subtask-4-5",
          "description": "Create impressum page at src/app/impressum/page.tsx",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/impressum/page.tsx"
          ],
          "patterns_from": [
            "src/pages/impressum.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/impressum",
            "checks": [
              "Page renders",
              "Legal content visible"
            ]
          },
          "notes": "Simple page with Impressum component. Add metadata export.",
          "status": "pending"
        },
        {
          "id": "subtask-4-6",
          "description": "Create datenschutz page at src/app/datenschutz/page.tsx",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/datenschutz/page.tsx"
          ],
          "patterns_from": [
            "src/pages/datenschutz.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/datenschutz",
            "checks": [
              "Page renders",
              "Privacy policy visible"
            ]
          },
          "notes": "Simple page with Datenschutz component. Add metadata export.",
          "status": "pending"
        },
        {
          "id": "subtask-4-7",
          "description": "Create not-found page at src/app/not-found.tsx",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/not-found.tsx"
          ],
          "patterns_from": [
            "src/pages/404.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000/nonexistent",
            "checks": [
              "404 page renders",
              "Shows German error message",
              "Back to home link works"
            ]
          },
          "notes": "App Router uses not-found.tsx instead of 404.tsx. Keep same German content. Add metadata export.",
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-api",
      "name": "API Route Migration",
      "type": "implementation",
      "description": "Migrate API routes to App Router route handlers",
      "depends_on": [
        "phase-1-dependencies"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Create newsletter API route at src/app/api/newsletter/route.ts",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/api/newsletter/route.ts"
          ],
          "patterns_from": [
            "src/pages/api/newsletter/index.ts"
          ],
          "verification": {
            "type": "api",
            "method": "POST",
            "url": "http://localhost:3000/api/newsletter",
            "body": {
              "email": "test@example.com"
            },
            "expected_status": 200
          },
          "notes": "Convert to route handler: export async function POST(request: NextRequest). Use await request.json() for body. Return NextResponse.json().",
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Create email API route at src/app/api/email/route.ts",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/app/api/email/route.ts"
          ],
          "patterns_from": [
            "src/pages/api/email/index.ts"
          ],
          "verification": {
            "type": "api",
            "method": "POST",
            "url": "http://localhost:3000/api/email",
            "body": {
              "name": "Test",
              "email": "test@example.com",
              "message": "Test",
              "phone": "123"
            },
            "expected_status": 200
          },
          "notes": "Convert to route handler with withAxiom. CRITICAL: Call await req.log.flush() before every response. Use NextRequest/NextResponse.",
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-6-cleanup",
      "name": "Cleanup and Verification",
      "type": "cleanup",
      "description": "Remove old Pages Router files and verify complete migration",
      "depends_on": [
        "phase-4-pages",
        "phase-5-api"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Verify build succeeds with App Router",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && pnpm build",
            "expected": "Build completed successfully"
          },
          "notes": "Run full build to catch any TypeScript errors or build issues before removing old files.",
          "status": "pending"
        },
        {
          "id": "subtask-6-2",
          "description": "Remove old pages directory and files",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "files_to_delete": [
            "src/pages/_app.tsx",
            "src/pages/index.tsx",
            "src/pages/lashlift.tsx",
            "src/pages/lashextension-1-zu-1-technik.tsx",
            "src/pages/lashextension-volumentechnik.tsx",
            "src/pages/impressum.tsx",
            "src/pages/datenschutz.tsx",
            "src/pages/404.tsx",
            "src/pages/api/newsletter/index.ts",
            "src/pages/api/email/index.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && ls src/pages 2>/dev/null || echo 'pages directory removed'",
            "expected": "pages directory removed or empty"
          },
          "notes": "Only remove after build verification passes. Keep directory structure if other files exist.",
          "status": "pending"
        },
        {
          "id": "subtask-6-3",
          "description": "Final build and lint verification",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd /Users/mariogalla/development/augenblick && pnpm build && pnpm lint",
            "expected": "Build and lint pass"
          },
          "notes": "Final verification that everything works after cleanup.",
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 17,
    "services_involved": [
      "main"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-3-hooks",
            "phase-5-api"
          ],
          "reason": "Both depend only on phase-1-dependencies, work on different file sets. Hooks can run parallel to API route migration."
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution recommended for this migration due to tight dependencies between layout and pages"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 002 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "pnpm build succeeds without errors",
      "pnpm lint passes",
      "All 7 pages render at original URLs",
      "Cookie consent banner works and persists",
      "Newsletter signup form submits successfully",
      "Booking form submits successfully",
      "No console errors in browser"
    ],
    "verification_steps": [
      {
        "name": "Build Check",
        "command": "pnpm build",
        "expected_outcome": "Build completes with exit code 0",
        "type": "build",
        "required": true,
        "blocking": true
      },
      {
        "name": "Lint Check",
        "command": "pnpm lint",
        "expected_outcome": "No linting errors",
        "type": "lint",
        "required": true,
        "blocking": true
      },
      {
        "name": "Type Check",
        "command": "pnpm tsc --noEmit",
        "expected_outcome": "No TypeScript errors",
        "type": "typecheck",
        "required": true,
        "blocking": true
      },
      {
        "name": "Dev Server Start",
        "command": "pnpm dev",
        "expected_outcome": "Server starts on port 3000",
        "type": "runtime",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk architectural migration requires build verification and manual testing of all pages and forms. No new features being added, so focus is on regression prevention."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": false,
      "commands": [],
      "minimum_coverage": null,
      "notes": "No existing unit tests in project. Cookie consent hook could be tested but not blocking for migration."
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "curl -X POST http://localhost:3000/api/newsletter -H 'Content-Type: application/json' -d '{\"email\":\"test@example.com\"}'"
      ],
      "services_to_test": [
        "main"
      ],
      "notes": "API routes must respond correctly with new route handler format"
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": [],
      "notes": "No Playwright/Cypress setup in project. Manual browser testing required."
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000/",
          "checks": [
            "renders",
            "hero-visible",
            "navigation-works",
            "no-console-errors"
          ]
        },
        {
          "url": "http://localhost:3000/lashlift",
          "checks": [
            "renders",
            "content-visible"
          ]
        },
        {
          "url": "http://localhost:3000/lashextension-1-zu-1-technik",
          "checks": [
            "renders",
            "content-visible"
          ]
        },
        {
          "url": "http://localhost:3000/lashextension-volumentechnik",
          "checks": [
            "renders",
            "content-visible"
          ]
        },
        {
          "url": "http://localhost:3000/impressum",
          "checks": [
            "renders",
            "legal-content-visible"
          ]
        },
        {
          "url": "http://localhost:3000/datenschutz",
          "checks": [
            "renders",
            "privacy-content-visible"
          ]
        },
        {
          "url": "http://localhost:3000/nonexistent",
          "checks": [
            "404-page-renders",
            "german-message",
            "back-link-works"
          ]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": [],
      "notes": "No database schema changes in this migration"
    }
  },
  "qa_signoff": null,
  "last_updated": "2025-12-25T20:59:34.242083+00:00"
}