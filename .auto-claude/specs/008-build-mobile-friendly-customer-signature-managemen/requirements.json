{
  "task_description": "# PRD: Frontend\n\n## Ãœbersicht\n\nMobile-friendly Kundenverwaltung mit shadcn/ui Komponenten. Fokus auf schnellen Workflow fÃ¼r Unterschriften-Sammlung im Studio.\n\n---\n\n## Tech Stack\n- **UI:** shadcn/ui (Standard-Komponenten mit CSS Variables)\n- **Tabelle:** TanStack Table (shadcn Data Table)\n- **Forms:** React Hook Form + Zod\n- **Signature:** react-signature-canvas\n- **Icons:** Lucide React\n\n---\n\n## Routen-Struktur\n\n```\n/login                          â†’ Login-Seite\n/office                         â†’ Redirect zu /office/kunden\n/office/kunden                  â†’ Kundenliste (Tabelle)\n/office/kunden/neu              â†’ Neuen Kunden anlegen\n/office/kunden/[id]             â†’ Kunden-Details\n/office/kunden/[id]/bearbeiten  â†’ Kunden bearbeiten\n/office/kunden/[id]/datenschutz â†’ Unterschrift-Flow (Fullscreen)\n/office/datenschutz             â†’ GDPR-Versionen verwalten\n```\n\n---\n\n## Layout\n\n### Top Navigation (Mobile-friendly)\n\n```tsx\n// components/layout/top-nav.tsx\n\"use client\";\n\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport { Menu, Users, FileText, LogOut } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\nimport { cn } from \"@/lib/utils\";\n\nconst navItems = [\n  { href: \"/office/kunden\", label: \"Kunden\", icon: Users },\n  { href: \"/office/datenschutz\", label: \"Datenschutz\", icon: FileText },\n];\n\nexport function TopNav() {\n  const pathname = usePathname();\n\n  return (\n    <header className=\"sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur\">\n      <div className=\"container flex h-14 items-center\">\n        {/* Mobile Menu */}\n        <Sheet>\n          <SheetTrigger asChild className=\"md:hidden\">\n            <Button variant=\"ghost\" size=\"icon\">\n              <Menu className=\"h-5 w-5\" />\n            </Button>\n          </SheetTrigger>\n          <SheetContent side=\"left\" className=\"w-64\">\n            <nav className=\"flex flex-col gap-2 mt-8\">\n              {navItems.map((item) => (\n                <Link\n                  key={item.href}\n                  href={item.href}\n                  className={cn(\n                    \"flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors\",\n                    pathname.startsWith(item.href)\n                      ? \"bg-primary text-primary-foreground\"\n                      : \"hover:bg-muted\"\n                  )}\n                >\n                  <item.icon className=\"h-4 w-4\" />\n                  {item.label}\n                </Link>\n              ))}\n            </nav>\n          </SheetContent>\n        </Sheet>\n\n        {/* Logo */}\n        <Link href=\"/office\" className=\"font-semibold ml-2 md:ml-0\">\n          Studio\n        </Link>\n\n        {/* Desktop Nav */}\n        <nav className=\"hidden md:flex items-center gap-6 ml-8\">\n          {navItems.map((item) => (\n            <Link\n              key={item.href}\n              href={item.href}\n              className={cn(\n                \"text-sm font-medium transition-colors hover:text-primary\",\n                pathname.startsWith(item.href)\n                  ? \"text-primary\"\n                  : \"text-muted-foreground\"\n              )}\n            >\n              {item.label}\n            </Link>\n          ))}\n        </nav>\n\n        {/* Logout */}\n        <div className=\"ml-auto\">\n          <form action=\"/api/auth/logout\" method=\"POST\">\n            <Button variant=\"ghost\" size=\"icon\">\n              <LogOut className=\"h-4 w-4\" />\n            </Button>\n          </form>\n        </div>\n      </div>\n    </header>\n  );\n}\n```\n\n### Office Layout\n\n```tsx\n// app/office/layout.tsx\nimport { TopNav } from \"@/components/layout/top-nav\";\n\nexport default function OfficeLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <TopNav />\n      <main className=\"container py-6\">{children}</main>\n    </div>\n  );\n}\n```\n\n---\n\n## Seiten\n\n### 1. Kundenliste (`/office/kunden`)\n\n```tsx\n// app/office/kunden/page.tsx\nimport { Suspense } from \"react\";\nimport { CustomerTable } from \"@/components/customers/customer-table\";\nimport { CustomerTableSkeleton } from \"@/components/customers/customer-table-skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { Plus } from \"lucide-react\";\nimport Link from \"next/link\";\n\nexport default function CustomersPage() {\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold\">Kunden</h1>\n        <Button asChild>\n          <Link href=\"/office/kunden/neu\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Neu\n          </Link>\n        </Button>\n      </div>\n\n      <Suspense fallback={<CustomerTableSkeleton />}>\n        <CustomerTable />\n      </Suspense>\n    </div>\n  );\n}\n```\n\n### Customer Table Component\n\n```tsx\n// components/customers/customer-table.tsx\n\"use client\";\n\nimport { useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport {\n  ColumnDef,\n  flexRender,\n  getCoreRowModel,\n  getFilteredRowModel,\n  useReactTable,\n} from \"@tanstack/react-table\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { CheckCircle, AlertCircle, Search } from \"lucide-react\";\nimport type { CustomerWithSignatureStatus } from \"@/lib/services/customer.service\";\n\ninterface CustomerTableProps {\n  data: CustomerWithSignatureStatus[];\n}\n\nconst columns: ColumnDef<CustomerWithSignatureStatus>[] = [\n  {\n    accessorKey: \"lastName\",\n    header: \"Name\",\n    cell: ({ row }) => (\n      <div>\n        <div className=\"font-medium\">\n          {row.original.lastName}, {row.original.firstName}\n        </div>\n        {row.original.phone && (\n          <div className=\"text-sm text-muted-foreground\">\n            {row.original.phone}\n          </div>\n        )}\n      </div>\n    ),\n  },\n  {\n    accessorKey: \"hasActiveSignature\",\n    header: \"Datenschutz\",\n    cell: ({ row }) => (\n      <div className=\"flex items-center\">\n        {row.original.hasActiveSignature ? (\n          <Badge variant=\"outline\" className=\"text-green-600 border-green-600\">\n            <CheckCircle className=\"h-3 w-3 mr-1\" />\n            OK\n          </Badge>\n        ) : (\n          <Badge variant=\"outline\" className=\"text-orange-600 border-orange-600\">\n            <AlertCircle className=\"h-3 w-3 mr-1\" />\n            Fehlt\n          </Badge>\n        )}\n      </div>\n    ),\n  },\n];\n\nexport function CustomerTable({ data }: CustomerTableProps) {\n  const router = useRouter();\n  const [globalFilter, setGlobalFilter] = useState(\"\");\n  const [signatureFilter, setSignatureFilter] = useState<string>(\"all\");\n\n  const filteredData = data.filter((customer) => {\n    if (signatureFilter === \"signed\") return customer.hasActiveSignature;\n    if (signatureFilter === \"unsigned\") return !customer.hasActiveSignature;\n    return true;\n  });\n\n  const table = useReactTable({\n    data: filteredData,\n    columns,\n    getCoreRowModel: getCoreRowModel(),\n    getFilteredRowModel: getFilteredRowModel(),\n    globalFilterFn: \"includesString\",\n    state: {\n      globalFilter,\n    },\n    onGlobalFilterChange: setGlobalFilter,\n  });\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Filter Bar */}\n      <div className=\"flex flex-col sm:flex-row gap-4\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Suchen (Name, Telefon...)\"\n            value={globalFilter}\n            onChange={(e) => setGlobalFilter(e.target.value)}\n            className=\"pl-9\"\n          />\n        </div>\n        <Select value={signatureFilter} onValueChange={setSignatureFilter}>\n          <SelectTrigger className=\"w-full sm:w-48\">\n            <SelectValue placeholder=\"Alle Kunden\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">Alle Kunden</SelectItem>\n            <SelectItem value=\"signed\">Mit Unterschrift</SelectItem>\n            <SelectItem value=\"unsigned\">Ohne Unterschrift</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Table */}\n      <div className=\"rounded-md border\">\n        <Table>\n          <TableHeader>\n            {table.getHeaderGroups().map((headerGroup) => (\n              <TableRow key={headerGroup.id}>\n                {headerGroup.headers.map((header) => (\n                  <TableHead key={header.id}>\n                    {header.isPlaceholder\n                      ? null\n                      : flexRender(\n                          header.column.columnDef.header,\n                          header.getContext()\n                        )}\n                  </TableHead>\n                ))}\n              </TableRow>\n            ))}\n          </TableHeader>\n          <TableBody>\n            {table.getRowModel().rows?.length ? (\n              table.getRowModel().rows.map((row) => (\n                <TableRow\n                  key={row.id}\n                  className=\"cursor-pointer\"\n                  onClick={() => router.push(`/office/kunden/${row.original.id}`)}\n                >\n                  {row.getVisibleCells().map((cell) => (\n                    <TableCell key={cell.id}>\n                      {flexRender(\n                        cell.column.columnDef.cell,\n                        cell.getContext()\n                      )}\n                    </TableCell>\n                  ))}\n                </TableRow>\n              ))\n            ) : (\n              <TableRow>\n                <TableCell\n                  colSpan={columns.length}\n                  className=\"h-24 text-center\"\n                >\n                  Keine Kunden gefunden\n                </TableCell>\n              </TableRow>\n            )}\n          </TableBody>\n        </Table>\n      </div>\n    </div>\n  );\n}\n```\n\n---\n\n### 2. Kunden-Details (`/office/kunden/[id]`)\n\n```tsx\n// app/office/kunden/[id]/page.tsx\nimport { notFound } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { customerService } from \"@/lib/services/customer.service\";\nimport { gdprService } from \"@/lib/services/gdpr.service\";\nimport { auditService } from \"@/lib/services/audit.service\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport {\n  Pencil,\n  FileSignature,\n  CheckCircle,\n  AlertCircle,\n  ChevronDown,\n  ArrowLeft,\n} from \"lucide-react\";\nimport { formatDate } from \"@/lib/utils\";\nimport { AuditLog } from \"@/components/customers/audit-log\";\n\ninterface PageProps {\n  params: { id: string };\n}\n\nexport default async function CustomerDetailPage({ params }: PageProps) {\n  const result = await customerService.getWithSignatureStatus(params.id);\n\n  if (result.isErr()) {\n    notFound();\n  }\n\n  const customer = result.value;\n  const signaturesResult = await gdprService.getSignaturesForCustomer(params.id);\n  const signatures = signaturesResult.isOk() ? signaturesResult.value : [];\n  \n  const auditResult = await auditService.getForCustomer(params.id);\n  const auditLog = auditResult.isOk() ? auditResult.value : [];\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center gap-4\">\n        <Button variant=\"ghost\" size=\"icon\" asChild>\n          <Link href=\"/office/kunden\">\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Link>\n        </Button>\n        <div className=\"flex-1\">\n          <h1 className=\"text-2xl font-bold\">\n            {customer.firstName} {customer.lastName}\n          </h1>\n        </div>\n        <Button variant=\"outline\" asChild>\n          <Link href={`/office/kunden/${params.id}/bearbeiten`}>\n            <Pencil className=\"h-4 w-4 mr-2\" />\n            Bearbeiten\n          </Link>\n        </Button>\n      </div>\n\n      {/* Datenschutz Status Card */}\n      <Card className={customer.hasActiveSignature ? \"border-green-200\" : \"border-orange-200\"}>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              {customer.hasActiveSignature ? (\n                <>\n                  <CheckCircle className=\"h-5 w-5 text-green-600\" />\n                  Datenschutz unterschrieben\n                </>\n              ) : (\n                <>\n                  <AlertCircle className=\"h-5 w-5 text-orange-600\" />\n                  Unterschrift erforderlich\n                </>\n              )}\n            </CardTitle>\n            {!customer.hasActiveSignature && (\n              <Button asChild>\n                <Link href={`/office/kunden/${params.id}/datenschutz`}>\n                  <FileSignature className=\"h-4 w-4 mr-2\" />\n                  Jetzt unterschreiben\n                </Link>\n              </Button>\n            )}\n          </div>\n        </CardHeader>\n        {customer.lastSignedAt && (\n          <CardContent className=\"pt-0\">\n            <p className=\"text-sm text-muted-foreground\">\n              Letzte Unterschrift: {formatDate(customer.lastSignedAt)}\n            </p>\n          </CardContent>\n        )}\n      </Card>\n\n      {/* Kundendaten */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Kontaktdaten</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n            {customer.phone && (\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Telefon</p>\n                <p className=\"font-medium\">{customer.phone}</p>\n              </div>\n            )}\n            {customer.email && (\n              <div>\n                <p className=\"text-sm text-muted-foreground\">E-Mail</p>\n                <p className=\"font-medium\">{customer.email}</p>\n              </div>\n            )}\n            {customer.birthDate && (\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Geburtsdatum</p>\n                <p className=\"font-medium\">{formatDate(customer.birthDate)}</p>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Behandlungsnotizen */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Behandlungsnotizen</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {customer.treatmentNotes ? (\n            <p className=\"whitespace-pre-wrap\">{customer.treatmentNotes}</p>\n          ) : (\n            <p className=\"text-muted-foreground italic\">Keine Notizen vorhanden</p>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Audit Log (subtil, aufklappbar) */}\n      <Collapsible>\n        <CollapsibleTrigger asChild>\n          <Button variant=\"ghost\" className=\"w-full justify-between text-muted-foreground\">\n            <span className=\"text-sm\">Ã„nderungsverlauf</span>\n            <ChevronDown className=\"h-4 w-4\" />\n          </Button>\n        </CollapsibleTrigger>\n        <CollapsibleContent>\n          <AuditLog entries={auditLog} />\n        </CollapsibleContent>\n      </Collapsible>\n    </div>\n  );\n}\n```\n\n### Audit Log Component (subtil)\n\n```tsx\n// components/customers/audit-log.tsx\nimport { formatDate } from \"@/lib/utils\";\nimport type { CustomerAudit } from \"@/db/schema\";\n\ninterface AuditLogProps {\n  entries: (CustomerAudit & { user: { name: string; email: string } | null })[];\n}\n\nconst actionLabels: Record<string, string> = {\n  create: \"Erstellt\",\n  update: \"Bearbeitet\",\n  delete: \"GelÃ¶scht\",\n};\n\nexport function AuditLog({ entries }: AuditLogProps) {\n  if (entries.length === 0) {\n    return (\n      <p className=\"text-sm text-muted-foreground py-4\">\n        Keine Ã„nderungen vorhanden\n      </p>\n    );\n  }\n\n  return (\n    <div className=\"space-y-2 py-4\">\n      {entries.map((entry) => (\n        <div\n          key={entry.id}\n          className=\"text-sm text-muted-foreground border-l-2 border-muted pl-3 py-1\"\n        >\n          <span className=\"font-medium text-foreground\">\n            {actionLabels[entry.action] || entry.action}\n          </span>\n          {\" Â· \"}\n          {formatDate(entry.createdAt)}\n          {entry.user && ` Â· ${entry.user.name}`}\n        </div>\n      ))}\n    </div>\n  );\n}\n```\n\n---\n\n### 3. Kunde Anlegen/Bearbeiten\n\n```tsx\n// components/customers/customer-form.tsx\n\"use client\";\n\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useRouter } from \"next/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Loader2 } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport type { Customer } from \"@/db/schema\";\n\nconst customerSchema = z.object({\n  firstName: z.string().min(1, \"Vorname erforderlich\"),\n  lastName: z.string().min(1, \"Nachname erforderlich\"),\n  email: z.string().email(\"UngÃ¼ltige E-Mail\").or(z.literal(\"\")).optional(),\n  phone: z.string().optional(),\n  birthDate: z.string().optional(),\n  treatmentNotes: z.string().optional(),\n});\n\ntype CustomerFormData = z.infer<typeof customerSchema>;\n\ninterface CustomerFormProps {\n  customer?: Customer;\n  action: (formData: FormData) => Promise<{ success: boolean; error?: { message: string } }>;\n}\n\nexport function CustomerForm({ customer, action }: CustomerFormProps) {\n  const router = useRouter();\n  const isEditing = !!customer;\n\n  const form = useForm<CustomerFormData>({\n    resolver: zodResolver(customerSchema),\n    defaultValues: {\n      firstName: customer?.firstName ?? \"\",\n      lastName: customer?.lastName ?? \"\",\n      email: customer?.email ?? \"\",\n      phone: customer?.phone ?? \"\",\n      birthDate: customer?.birthDate\n        ? new Date(customer.birthDate).toISOString().split(\"T\")[0]\n        : \"\",\n      treatmentNotes: customer?.treatmentNotes ?? \"\",\n    },\n  });\n\n  const onSubmit = async (data: CustomerFormData) => {\n    const formData = new FormData();\n    Object.entries(data).forEach(([key, value]) => {\n      if (value) formData.append(key, value);\n    });\n\n    const result = await action(formData);\n\n    if (result.success) {\n      toast.success(isEditing ? \"Kunde aktualisiert\" : \"Kunde erstellt\");\n      router.push(\"/office/kunden\");\n    } else {\n      toast.error(result.error?.message ?? \"Ein Fehler ist aufgetreten\");\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>{isEditing ? \"Kunde bearbeiten\" : \"Neuer Kunde\"}</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"firstName\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Vorname *</FormLabel>\n                    <FormControl>\n                      <Input {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"lastName\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nachname *</FormLabel>\n                    <FormControl>\n                      <Input {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"phone\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Telefon</FormLabel>\n                    <FormControl>\n                      <Input type=\"tel\" {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>E-Mail</FormLabel>\n                    <FormControl>\n                      <Input type=\"email\" {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <FormField\n              control={form.control}\n              name=\"birthDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Geburtsdatum</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"treatmentNotes\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Behandlungsnotizen</FormLabel>\n                  <FormControl>\n                    <Textarea rows={4} {...field} />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"flex gap-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => router.back()}\n              >\n                Abbrechen\n              </Button>\n              <Button type=\"submit\" disabled={form.formState.isSubmitting}>\n                {form.formState.isSubmitting && (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                )}\n                {isEditing ? \"Speichern\" : \"Erstellen\"}\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </CardContent>\n    </Card>\n  );\n}\n```\n\n---\n\n### 4. Unterschrift-Flow (`/office/kunden/[id]/datenschutz`)\n\n**Fullscreen Layout ohne Navigation**\n\n```tsx\n// app/office/kunden/[id]/datenschutz/layout.tsx\nexport default function SignatureLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  // Kein TopNav - Fullscreen fÃ¼r Unterschrift\n  return <div className=\"min-h-screen bg-background\">{children}</div>;\n}\n```\n\n```tsx\n// app/office/kunden/[id]/datenschutz/page.tsx\nimport { notFound } from \"next/navigation\";\nimport { customerService } from \"@/lib/services/customer.service\";\nimport { gdprService } from \"@/lib/services/gdpr.service\";\nimport { SignatureFlow } from \"@/components/signature/signature-flow\";\n\ninterface PageProps {\n  params: { id: string };\n}\n\nexport default async function SignaturePage({ params }: PageProps) {\n  const customerResult = await customerService.getById(params.id);\n  const gdprResult = await gdprService.getActiveVersion();\n\n  if (customerResult.isErr() || gdprResult.isErr()) {\n    notFound();\n  }\n\n  return (\n    <SignatureFlow\n      customer={customerResult.value}\n      gdprVersion={gdprResult.value}\n    />\n  );\n}\n```\n\n### Signature Flow Component\n\n```tsx\n// components/signature/signature-flow.tsx\n\"use client\";\n\nimport { useState, useRef } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport SignatureCanvas from \"react-signature-canvas\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Loader2, RotateCcw, Check, ArrowLeft } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { createSignatureAction } from \"@/app/actions/gdpr.actions\";\nimport type { Customer, GdprVersion } from \"@/db/schema\";\nimport Markdown from \"react-markdown\";\n\ntype Step = \"read\" | \"sign\" | \"success\";\n\ninterface SignatureFlowProps {\n  customer: Customer;\n  gdprVersion: GdprVersion;\n}\n\nexport function SignatureFlow({ customer, gdprVersion }: SignatureFlowProps) {\n  const router = useRouter();\n  const sigCanvas = useRef<SignatureCanvas>(null);\n  \n  const [step, setStep] = useState<Step>(\"read\");\n  const [agreed, setAgreed] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  const handleClear = () => {\n    sigCanvas.current?.clear();\n  };\n\n  const handleSubmit = async () => {\n    if (!sigCanvas.current || sigCanvas.current.isEmpty()) {\n      toast.error(\"Bitte unterschreiben Sie im Feld\");\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    const signatureData = sigCanvas.current.toDataURL(\"image/png\");\n\n    const result = await createSignatureAction({\n      customerId: customer.id,\n      gdprVersionId: gdprVersion.id,\n      signature: signatureData,\n    });\n\n    setIsSubmitting(false);\n\n    if (result.success) {\n      setStep(\"success\");\n    } else {\n      toast.error(result.error?.message ?? \"Fehler beim Speichern\");\n    }\n  };\n\n  const handleBackToOffice = () => {\n    router.push(\"/office/kunden\");\n  };\n\n  const handleBackToCustomer = () => {\n    router.push(`/office/kunden/${customer.id}`);\n  };\n\n  // Step 1: Datenschutz lesen\n  if (step === \"read\") {\n    return (\n      <div className=\"min-h-screen flex flex-col p-4 sm:p-6\">\n        <div className=\"flex items-center gap-4 mb-4\">\n          <Button variant=\"ghost\" size=\"icon\" onClick={handleBackToCustomer}>\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Button>\n          <div>\n            <h1 className=\"text-xl font-bold\">{gdprVersion.title}</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              fÃ¼r {customer.firstName} {customer.lastName}\n            </p>\n          </div>\n        </div>\n\n        <Card className=\"flex-1 flex flex-col\">\n          <ScrollArea className=\"flex-1 p-6\">\n            <div className=\"prose prose-sm max-w-none\">\n              <Markdown>{gdprVersion.content}</Markdown>\n            </div>\n          </ScrollArea>\n\n          <CardContent className=\"border-t pt-4 space-y-4\">\n            <div className=\"flex items-start gap-3\">\n              <Checkbox\n                id=\"agree\"\n                checked={agreed}\n                onCheckedChange={(checked) => setAgreed(checked === true)}\n              />\n              <label htmlFor=\"agree\" className=\"text-sm leading-tight\">\n                Ich habe die DatenschutzerklÃ¤rung gelesen und stimme der\n                Verarbeitung meiner Daten zu.\n              </label>\n            </div>\n\n            <Button\n              className=\"w-full\"\n              size=\"lg\"\n              disabled={!agreed}\n              onClick={() => setStep(\"sign\")}\n            >\n              Weiter zur Unterschrift\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Step 2: Unterschreiben\n  if (step === \"sign\") {\n    return (\n      <div className=\"min-h-screen flex flex-col p-4 sm:p-6\">\n        <div className=\"flex items-center gap-4 mb-4\">\n          <Button variant=\"ghost\" size=\"icon\" onClick={() => setStep(\"read\")}>\n            <ArrowLeft className=\"h-4 w-4\" />\n          </Button>\n          <div>\n            <h1 className=\"text-xl font-bold\">Unterschrift</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              {customer.firstName} {customer.lastName}\n            </p>\n          </div>\n        </div>\n\n        <Card className=\"flex-1 flex flex-col\">\n          <CardContent className=\"flex-1 flex flex-col p-4 sm:p-6\">\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              Bitte unterschreiben Sie im Feld unten:\n            </p>\n\n            <div className=\"flex-1 border-2 border-dashed rounded-lg bg-white min-h-[200px]\">\n              <SignatureCanvas\n                ref={sigCanvas}\n                canvasProps={{\n                  className: \"w-full h-full\",\n                }}\n                backgroundColor=\"white\"\n              />\n            </div>\n\n            <div className=\"flex gap-4 mt-4\">\n              <Button\n                variant=\"outline\"\n                onClick={handleClear}\n                className=\"flex-1\"\n              >\n                <RotateCcw className=\"h-4 w-4 mr-2\" />\n                LÃ¶schen\n              </Button>\n              <Button\n                onClick={handleSubmit}\n                disabled={isSubmitting}\n                className=\"flex-1\"\n              >\n                {isSubmitting ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <Check className=\"h-4 w-4 mr-2\" />\n                )}\n                BestÃ¤tigen\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Step 3: Erfolg\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md text-center\">\n        <CardContent className=\"pt-8 pb-8 space-y-6\">\n          <div className=\"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center\">\n            <Check className=\"h-8 w-8 text-green-600\" />\n          </div>\n\n          <div className=\"space-y-2\">\n            <h1 className=\"text-2xl font-bold\">Vielen Dank!</h1>\n            <p className=\"text-muted-foreground\">\n              Die DatenschutzerklÃ¤rung wurde erfolgreich unterschrieben.\n            </p>\n            <p className=\"text-lg font-medium text-primary\">\n              Viel SpaÃŸ bei der Behandlung! ðŸ’…\n            </p>\n          </div>\n\n          <Button onClick={handleBackToOffice} size=\"lg\" className=\"w-full\">\n            ZurÃ¼ck zur Ãœbersicht\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n```\n\n---\n\n### 5. Datenschutz-Verwaltung (`/office/datenschutz`)\n\n```tsx\n// app/office/datenschutz/page.tsx\nimport { gdprService } from \"@/lib/services/gdpr.service\";\nimport { GdprVersionList } from \"@/components/gdpr/gdpr-version-list\";\nimport { GdprVersionForm } from \"@/components/gdpr/gdpr-version-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { Plus } from \"lucide-react\";\n\nexport default async function GdprPage() {\n  const result = await gdprService.getAllVersions();\n  const versions = result.isOk() ? result.value : [];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold\">DatenschutzerklÃ¤rung</h1>\n      </div>\n\n      <GdprVersionList versions={versions} />\n      \n      <GdprVersionForm />\n    </div>\n  );\n}\n```\n\n```tsx\n// components/gdpr/gdpr-version-list.tsx\n\"use client\";\n\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { CheckCircle } from \"lucide-react\";\nimport { setActiveGdprVersionAction } from \"@/app/actions/gdpr.actions\";\nimport { toast } from \"sonner\";\nimport type { GdprVersion } from \"@/db/schema\";\nimport { formatDate } from \"@/lib/utils\";\n\ninterface GdprVersionListProps {\n  versions: GdprVersion[];\n}\n\nexport function GdprVersionList({ versions }: GdprVersionListProps) {\n  const handleSetActive = async (id: string) => {\n    const result = await setActiveGdprVersionAction(id);\n    if (result.success) {\n      toast.success(\"Version aktiviert\");\n    } else {\n      toast.error(result.error?.message);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      {versions.map((version) => (\n        <Card key={version.id} className={version.isActive ? \"border-primary\" : \"\"}>\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"text-lg flex items-center gap-2\">\n                Version {version.version}\n                {version.isActive && (\n                  <Badge className=\"bg-primary\">\n                    <CheckCircle className=\"h-3 w-3 mr-1\" />\n                    Aktiv\n                  </Badge>\n                )}\n              </CardTitle>\n              {!version.isActive && (\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => handleSetActive(version.id)}\n                >\n                  Aktivieren\n                </Button>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-sm text-muted-foreground\">\n              Erstellt am {formatDate(version.createdAt)}\n            </p>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}\n```\n\n```tsx\n// components/gdpr/gdpr-version-form.tsx\n\"use client\";\n\nimport { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Plus, ChevronDown, Loader2 } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { createGdprVersionAction } from \"@/app/actions/gdpr.actions\";\n\nconst schema = z.object({\n  version: z.string().min(1, \"Version erforderlich\"),\n  title: z.string().min(1, \"Titel erforderlich\"),\n  content: z.string().min(1, \"Inhalt erforderlich\"),\n  isActive: z.boolean().default(false),\n});\n\ntype FormData = z.infer<typeof schema>;\n\nexport function GdprVersionForm() {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const form = useForm<FormData>({\n    resolver: zodResolver(schema),\n    defaultValues: {\n      version: \"\",\n      title: \"DatenschutzerklÃ¤rung\",\n      content: \"\",\n      isActive: false,\n    },\n  });\n\n  const onSubmit = async (data: FormData) => {\n    const result = await createGdprVersionAction(data);\n\n    if (result.success) {\n      toast.success(\"Version erstellt\");\n      form.reset();\n      setIsOpen(false);\n    } else {\n      toast.error(result.error?.message);\n    }\n  };\n\n  return (\n    <Collapsible open={isOpen} onOpenChange={setIsOpen}>\n      <CollapsibleTrigger asChild>\n        <Button variant=\"outline\" className=\"w-full justify-between\">\n          <span className=\"flex items-center gap-2\">\n            <Plus className=\"h-4 w-4\" />\n            Neue Version erstellen\n          </span>\n          <ChevronDown className={`h-4 w-4 transition-transform ${isOpen ? \"rotate-180\" : \"\"}`} />\n        </Button>\n      </CollapsibleTrigger>\n\n      <CollapsibleContent>\n        <Card className=\"mt-4\">\n          <CardHeader>\n            <CardTitle>Neue Datenschutzversion</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"version\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Version *</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"z.B. 2.0\" {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={form.control}\n                    name=\"title\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Titel *</FormLabel>\n                        <FormControl>\n                          <Input {...field} />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"content\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Inhalt (Markdown) *</FormLabel>\n                      <FormControl>\n                        <Textarea rows={10} {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"isActive\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex items-center gap-2\">\n                      <FormControl>\n                        <Checkbox\n                          checked={field.value}\n                          onCheckedChange={field.onChange}\n                        />\n                      </FormControl>\n                      <FormLabel className=\"!mt-0\">\n                        Sofort aktivieren\n                      </FormLabel>\n                    </FormItem>\n                  )}\n                />\n\n                <Button type=\"submit\" disabled={form.formState.isSubmitting}>\n                  {form.formState.isSubmitting && (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  )}\n                  Erstellen\n                </Button>\n              </form>\n            </Form>\n          </CardContent>\n        </Card>\n      </CollapsibleContent>\n    </Collapsible>\n  );\n}\n```\n\n---\n\n## shadcn/ui Komponenten benÃ¶tigt\n\n```bash\nnpx shadcn@latest add button card input textarea checkbox badge table select scroll-area sheet collapsible form\n```\n\n---\n\n## ZusÃ¤tzliche Dependencies\n\n```bash\npnpm add react-signature-canvas react-markdown\npnpm add -D @types/react-signature-canvas\n```\n\n---\n\n## Utils\n\n```ts\n// lib/utils.ts\nimport { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n\nexport function formatDate(date: Date | string): string {\n  return new Intl.DateTimeFormat(\"de-DE\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  }).format(new Date(date));\n}\n```\n\n---\n\n## Zusammenfassung\n\n### Seiten\n\n| Route | Beschreibung |\n|-------|--------------|\n| `/office/kunden` | Tabelle mit Suche & Filter |\n| `/office/kunden/neu` | Neuen Kunden anlegen |\n| `/office/kunden/[id]` | Kunden-Details mit Unterschrift-Status |\n| `/office/kunden/[id]/bearbeiten` | Kunden bearbeiten |\n| `/office/kunden/[id]/datenschutz` | Fullscreen Unterschrift-Flow |\n| `/office/datenschutz` | GDPR-Versionen verwalten |\n\n### Unterschrift-Flow\n\n1. **Lesen** â†’ Datenschutztext (Markdown) + Checkbox \"Ich stimme zu\"\n2. **Unterschreiben** â†’ Fullscreen SignatureCanvas\n3. **Erfolg** â†’ \"Danke, viel SpaÃŸ bei der Behandlung!\" + Button zurÃ¼ck zur Ãœbersicht\n\n### Features\n\n- Mobile-friendly TopNav mit Sheet-Menu\n- TanStack Table mit Suche und Unterschrift-Filter\n- Klickbare Zeilen â†’ Detail-Seite\n- Farbige Badges fÃ¼r Unterschrift-Status (grÃ¼n/orange)\n- Subtiler Audit-Log (aufklappbar)\n- Markdown-Rendering fÃ¼r Datenschutztext",
  "workflow_type": "feature"
}